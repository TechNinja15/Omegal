<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Omegle Clone – Friend Chat</title>
<style>
body{font-family:sans-serif;margin:20px;}
#chat{border:1px solid #ccc;height:200px;overflow:auto;padding:5px;margin-top:10px;}
#video-container{display:flex;gap:10px;margin-top:10px;}
video{width:300px;height:200px;background:#000;}
button,input{margin:5px;}
</style>
</head>
<body>
<h2>Omegle Clone – Friend Chat</h2>

<input id="roomCode" placeholder="Enter room code">
<button id="join">Join Room</button>
<div id="status"></div>

<div id="chat"></div>
<input id="msg" placeholder="Type message..."><button id="send">Send</button>

<div id="video-container">
  <video id="localVideo" autoplay muted></video>
  <video id="remoteVideo" autoplay></video>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
let room = null;

// UI functions
const status = document.getElementById('status');
const chat = document.getElementById('chat');
function append(msg){ chat.innerHTML += '<div>'+msg+'</div>'; chat.scrollTop = chat.scrollHeight; }

// Join room
document.getElementById('join').onclick = () => {
  const code = document.getElementById('roomCode').value.trim();
  if(code){
    room = code;
    socket.emit('join_room', code);
    status.textContent = 'Joining room...';
  }
};

// Send text messages
document.getElementById('send').onclick = () => {
  const t = document.getElementById('msg').value;
  if(room && t){ socket.emit('message',{room,text:t}); append('Me: '+t); document.getElementById('msg').value=''; }
};

// Socket events
socket.on('waiting', () => status.textContent='Waiting for friend to join...');
socket.on('paired', ({room: r}) => {
  room = r;
  status.textContent='Friend connected! Room: '+room;
  startVideoChat();
});
socket.on('message', ({from,text}) => append('Friend: '+text));

// ===== WebRTC video =====
let localStream, peerConn;
const localVideo = document.getElementById('localVideo');
const remoteVideo = document.getElementById('remoteVideo');

async function startVideoChat(){
  if(localStream) return; // prevent multiple calls

  // Get camera/mic
  localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  localVideo.srcObject = localStream;

  // Create peer connection
  peerConn = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
  localStream.getTracks().forEach(track => peerConn.addTrack(track, localStream));
  peerConn.ontrack = e => { remoteVideo.srcObject = e.streams[0]; }
  peerConn.onicecandidate = e => { if(e.candidate) socket.emit('signal',{room,data:{candidate:e.candidate}}); }
}

// Handle signaling
socket.on('signal', async (data) => {
  if(!peerConn) return;

  if(data.sdp){
    await peerConn.setRemoteDescription(data.sdp);
    if(data.sdp.type==='offer'){
      const answer = await peerConn.createAnswer();
      await peerConn.setLocalDescription(answer);
      socket.emit('signal',{room,data:{sdp:answer}});
    }
  }
  if(data.candidate) peerConn.addIceCandidate(data.candidate);
});

// After getting paired, one peer creates offer
socket.on('paired', async () => {
  if(!peerConn.localDescription){
    const offer = await peerConn.createOffer();
    await peerConn.setLocalDescription(offer);
    socket.emit('signal',{room,data:{sdp:offer}});
  }
});

</script>
</body>
</html>
